---
title: "Analyzing Business Relations & Documents"
subtitle: "Spatial Statistics"
author: "Prof. Dr. Jörg Schoder"
institute: "FFHS" 
date: "`r Sys.Date()`"
bibliography: ../../lit/my_bib.bib
reference-section-title: Quellenverzeichnis
output:
  xaringan::moon_reader:
    self_contained: true
    css: 
         - default
         - ../../css/ffhs-theme_js.css
         - xaringan-themer.css
    includes:
      after_body: ../../css/insert-logo.html
    lib_dir: ../../libs
    nature:
      slideNumberFormat: "%current%/%total%"
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
    seal: false
    

    
---
class: title-slide

```{r xaringan-themer, include=FALSE}
library(xaringanthemer)
style_xaringan(text_color = "#d50006",inverse_text_color = "#FFFFFF",inverse_background_color = "#d50006", title_slide_background_color = "#d50006",header_background_color = "#d50006",header_color = "#FFFFFF",header_h1_font_size = "32px",
  header_h2_font_size = "26px",link_color="#502479",
  header_h3_font_size = "20px",text_slide_number_color = "#d50006",text_slide_number_font_size = "0.5em")
```

```{r xaringanExtra, echo=FALSE}
xaringanExtra::use_progress_bar(color = "#d50006", location = "bottom")
xaringanExtra::use_xaringan_extra(c("tile_view","scribble","panelset","tachyons"))
xaringanExtra::style_panelset_tabs(font_family = "inherit")
#xaringanExtra::use_search(show_icon = TRUE)
#weitere: "share_again","animate_css", "webcam","freezeframe","clipboard","fit_screen","extra-styles" 
xaringanExtra::use_editable(expires = 1)
xaringanExtra::use_freezeframe(trigger = "hover")
``` 

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
library(latex2exp)
library(fontawesome)
library(emo)
source(xfun::from_root("lit","helper.R"))
library(RefManageR)
BibOptions(check.entries = FALSE, 
           bib.style = "authoryear", 
           style = "markdown",
           dashed = TRUE)
file.name <- system.file("Bib", 
                         "my_bib.bib", 
                         package = "RefManageR")
bib <- ReadBib(xfun::from_root("lit","my_bib.bib"))
```

# ER018 - Analyzing Business Relations & Documents

## PVA3

### Soziale Netzwerkanalyse

 

<br>
<br>
<br>
<br>
<br>
<br>
<br>
### FS 2024
<br>
### Prof. Dr. Jörg Schoder
.mycontacts[
`r fa('github')` @FFHS-EconomicResearch
`r fa('linkedin')` @jfschoder
]


---
layout: true

<div class="my-footer"></div>       

<div style="position: absolute;left:400px;bottom:10px;font-size:9px">`r fa('creative-commons')``r rmarkdown::metadata$author`</div>


---
name: agenda
class: left

.blockquote[Agenda]

## Einführung in die Netzwerkanalayse


* Netzwerkdaten erzeugen und importieren

* Netzwerkdaten visualisieren

* Vermessung von Netzwerken





---
class: inverse, center, middle

## Netzwerkdaten erzeugen und importieren

.blockquote[Elementare Netzwerkdaten]

.blockquote[Netzwerkobjekte erzeugen]

.blockquote[Netzwerkdaten importieren]

.blockquote[Netzwerkdaten transformieren]

---
class: left

.blockquote[Elementare Netzwerkdaten]

## Akteure, Beziehungen und Eigenschaften

* Knoten (mit Eigenschaften):

```{r}
#| message: false
#| warning: false
library(tidyverse)
#most popular babynames in CH 2022
actors <- tibble(name=c("Emma","Mia","Sofia","Noah","Liam","Matteo"),
                 sex=c("weiblich","weiblich","weiblich","männlich","männlich","männlich"))
```

* Kanten (mit Eigenschaften):

```{r}
ties <- tibble(from=c("Noah","Noah","Noah","Noah","Noah"),
                to=c("Emma","Mia","Sofia","Liam","Matteo"),
                type=c("Partnerin","Kollegin","Kollegin","Freund","Freund"),
               interaction=c(7,2,3,5,2))

```


---
class: left

.blockquote[Knoten und Kanten]

## Aufgabe: Erzeuge Knoten und Kanten zum dargestellten Graphen:

```{r}
#| echo: false
#| message: false
#| warning: false
FFHSred <- "#d50006"
FFHSpurp <- "#502479"
library(ggraph)
knoten <- tibble(name=c("A","B","C","D","E","F","G","H"),type=c("Alter","Alter","Alter","Alter","Alter","Alter","Alter","Ego"))
kanten <- tibble(from=c("H","H","H","H","H","H","H","A","A","A","B","B","B","B","B","C","C","D","E","F","F","F","G","G","G","G"),
                 to=c("A","B","C","D","E","F","G","B","G","H","A","C","F","G","H","B","H","H","H","B","G","H","A","B","F","H")
)
library(tidygraph)
n_ges <- tbl_graph(nodes = knoten, edges = kanten, directed = FALSE)
set.seed(4)
n_ges %>% ggraph(layout = "graphopt") +
  geom_node_point(aes(color=type),size=10,
                  show.legend = FALSE) +
  geom_node_text(aes(label = name),color=FFHSpurp) +
  geom_edge_link(start_cap = ggraph::circle(4,'mm'),
                 end_cap = ggraph::circle(4,'mm'),
                 width=1,color=FFHSpurp) +
  theme_void()
```


---
class: left

.blockquote[Netzwerkobjekte erzeugen]

## Netzwerkobjekte mit igraph und tidygraph

* igraph-Objekt erzeugen

```{r}
#| message: false
library(igraph) # Paket laden
ig <- graph_from_data_frame(ties, directed=FALSE, vertices=actors)
class(ig)
```

* `tbl_graph()`-Objekt erzeugen

```{r}
#| message: false
library(tidygraph) # Paket laden
tg <- tbl_graph(nodes = actors, edges = ties, directed = FALSE)
```


---
class: left

.blockquote[Netzwerkdaten importieren]

## Beispiel: Daten "Hochzeitsmarkt Florenz"

* Daten im **network**-Paket enthalten

```{r}
#| message: false
#| warning: false
library(network) # ggf. Paket installieren
data(flo)
net_flo <- graph_from_adjacency_matrix(flo)
tidy_flo <- as_tbl_graph(net_flo)
```


---
class: left

.blockquote[Netzwerkdaten importieren]

## Beispiel: Datensatz "Media"-Example importieren


* Knoten importieren

```{r}
#| message: false
#| warning: false
my_in_file <- "Dataset1-Media-Example-NODES.csv"
nodes <- readr::read_csv(xfun::from_root("data","raw","PVA2",my_in_file))
```

--

* Aufgabe: Kanten importieren:

```{r}
#| echo: false
#| message: false
#| warning: false
my_in_file <- "Dataset1-Media-Example-EDGES.csv"
links <- readr::read_csv(xfun::from_root("data","raw","PVA2",my_in_file))
```


* Download-Links für die Datensätze:
  * [Knoten](https://github.com/FFHS-EconomicResearch/ER018/blob/main/data/raw/PVA2/Dataset1-Media-Example-NODES.csv)
  * [Kanten](https://github.com/FFHS-EconomicResearch/ER018/blob/main/data/raw/PVA2/Dataset1-Media-Example-EDGES.csv)




---
class: left

.blockquote[Netzwerkdaten transformieren]

## Beispiel: Florentinische Familien


.panelset[
.panel[.panel-name[Transformation]
* Nützliche **tidygraph**-Funktionen
  * `activate()`
  * `.E()`, `.N()`

* Beispiel: Hinzufügen der Eigenschaft "direkter Zugang zu den Medici"

```{r}
flo_tidy <- tidy_flo %>% 
              activate("edges") %>%  # Kanten aktivieren
              mutate(to_medici=(.N()$name[from]=="Medici" |
                                .N()$name[to]=="Medici"))
```
]
.panel[.panel-name[Vorher]
```{r}
tidy_flo
```
]
.panel[.panel-name[Vorher]
```{r}
flo_tidy
``` 
]
]



---
class: left

.blockquote[Netzwerkdaten transformieren]

## Teilgruppen (Subgraph) extrahieren

```{r}
medici_sub <- flo_tidy %>% 
  activate("edges") %>% 
  filter(to_medici)
```

---
class: inverse, center, middle

## Netzwerkdaten visualisieren


.blockquote[Einfache plots mit igraph]

.blockquote[Flexible plots mit ggraph]




???

* ToDo Interaktive Plots mit visNetwork




---
class: left

.blockquote[Plots mit igraph]

## Vom Netzwerkobjekt zum Graphen

```{r}
#| out-width: 40%
#| fig-align: 'center'
plot(ig)
```


---
class: left

.blockquote[Flexible Plots mit ggraph]

## Vom Netzwerkobjekt zum Graphen

```{r}
#| out-width: 35%
#| fig-align: 'center'
library(ggraph)
tg %>% ggraph(layout = "graphopt") + 
            geom_node_point(size=7,color=FFHSred) +
            geom_node_text(aes(label = name,color=FFHSpurp), 
                           vjust=1.55,hjust=1.2,show.legend = FALSE) +
            geom_edge_link(color=FFHSpurp,width=1.1,
                          start_cap = ggraph::circle(3,'mm'),
                          end_cap = ggraph::circle(3,'mm')) +
            theme_void()
```



---
class: left

.blockquote[Flexible Plots mit ggraph]

## Aufgabe: Medici-Netzwerk

.content-box-purple[
.white[
Erzeuge einen Graphen zum Medici-Netzwerk. Die Kanten von Familien mit "direktem Zugang" zu den Medici sollen dabei hervorgehoben werden.]
]


```{r}
#| echo: false
#| message: false
#| warning: false
ggraph(flo_tidy,"stress") + 
  geom_edge_link0(aes(edge_color = to_medici))+
  geom_node_point(shape = 21, size = 10, fill = "grey66")+
  geom_node_text(aes(label = name))+
  theme_graph()
```


???

geom_edge_link0(aes(edge_color = to_medici))+








---
class: inverse, center, middle

## Vermessung von Netzwerken


.blockquote[Zentralität]

.blockquote[Dichte]

.blockquote[Pfade und Distanzen]

.blockquote[Verbundenheit]

.blockquote[Clustering]



???

Gliederung nach Barabasi (2016)







---
class:

.blockquote[Zentralität]

## Beispiel: Freundschaftsnetzwerk

* `activate()`

```{r}
tg %>% 
    activate(nodes) %>% 
    mutate(degree = centrality_degree()) 

tg %>%  activate(edges) %>% 
    mutate(betweenness = centrality_edge_betweenness(), 
         # .N() gets the nodes data from edge you're accessing
         homo = (.N()$sex[from] == .N()$sex[to]))
```


---
class: left

.blockquote[Zentralität]

## Beispiel: Florentinische Familien

.content-box-purple[
.white[
Ermittle zwei Zentralitätsmaße für das florentinische Familiennetzwerk.]
]

```{r}
#| echo: false
#| message: false
#| warning: false
flo_tidy %>% 
  activate("nodes") %>% 
  mutate(degree = centrality_degree(),
         betweenness = centrality_betweenness())
```

---
class: left

.blockquote[Zentralität]

## Grafische Darstellung der Zentralität am Beispiel "Medici"

```{r}
#| echo: false
#| message: false
#| warning: false
flo_tidy %>% 
  activate("nodes") %>% 
  mutate(degree = centrality_degree(),
         betweenness = centrality_betweenness()) %>% 
ggraph("stress",bbox=10) + 
  geom_edge_link0(edge_color = "black")+
  geom_node_point(shape = 21, aes(size=degree,fill=betweenness))+
  geom_node_text(aes(label = name))+
  scale_fill_gradient(low="#104E8B",high="#CD2626")+
  scale_size(range = c(4,10))+
  theme_graph()
```



---
class: left

.blockquote[Pfade und Distanzen]

## Durchmesser

```{r}
tg  %>%
 mutate(Diameter = graph_diameter())
```




---
class: left

.blockquote[Clustering]

## Beispiel mit Zufallsdaten

```{r}
#| message: false
#| warning: false
# create random graph with group structure (igraph equivalent is sample_islands())
play_islands(4, 12, 0.8, 4) %>% 
  mutate(community = as.factor(group_louvain())) %>% 
  activate("edges") %>% 
  mutate(community = as.factor(ifelse(.N()$community[from]==.N()$community[to],.N()$community[from],5))) %>% 
  ggraph(layout = 'stress') + 
  geom_edge_link0(aes(edge_colour=community),show.legend = FALSE) + 
  geom_node_point(aes(fill = community), shape = 21, size = 6) + 
  scale_fill_brewer(palette = "Set3")+
  scale_edge_color_brewer(palette = "Set3")+
  theme_graph(background = "grey88")
```



???

* Fokus auf einer Entität bzw. einem Knoten ("Ego")

---
class: inverse,center,middle

# Wir brauchen eine Pause.

---

background-image: url("http://bit.ly/cs631-donkey")
background-size: 80%





---
class: left

## Quellenverzeichnis

.ref-slide[
```{r, results='asis', echo=FALSE, warning=FALSE}
PrintBibliography(bib)
```
]
